<!DOCTYPE html>

<head>
  <title>hls.js demo page</title>
</head>

<body>
  <div class="header-container">
    <header class="wrapper clearfix">
      <h1 class="title">hls.js demo page</h1>
    </header>
  </div>

  <div class="main-container">
    <div class="main wrapper clearfix">
      <article>
        <header>
          <p>
            transmuxing HLS playlist into MP4 fragments - Media Source Extension-compatible media segments on the fly.
            Check out the demo below in Chrome / Firefox or Safari !
          </p>
        </header>
        <section>
          <pre id='HlsDimension'></pre>
          <pre id='HlsUrl'></pre>
          <button style="font: bold 20px Arial" onclick="loadTestVid()">Load a test Video</button>
          <button style="font: bold 20px Arial" onclick="loadRandomPykeVid()">Load a Random Pyke Video</button>
          <button style="font: bold 20px Arial" onclick="loadRandomLiveVid()">Load a Random Live Video</button>
          <button style="font: bold 20px Arial" onclick="loadNextPykeVid()">Load Next Pyke Video</button>
          <button style="font: bold 20px Arial" onclick="loadDMRandomVid()">Load a random DM Video</button><br><br>
          <div id='buttons'>
            <button onclick="document.getElementById('video').play()">play()</button>
            <button onclick="document.getElementById('video').pause()">pause()</button><br>
            <button onclick="document.getElementById('video').currentTime+=10">currentTime+=10</button>
            <button onclick="document.getElementById('video').currentTime-=10">currentTime-=10</button>
            <button onclick="document.getElementById('video').currentTime=50">currentTime=50</button><br>
            <button onclick="document.getElementById('video').playbackRate++">playbackRate++</button>
            <button onclick="document.getElementById('video').playbackRate--">playbackRate--</button>
            <button onclick="document.getElementById('video').playbackRate+=0.1">playbackRate+=0.1</button>
            <button onclick="document.getElementById('video').playbackRate-=0.1">playbackRate-=0.1</button><br>
            <button onclick="document.getElementById('video').volume+=0.1">volume+=0.1</button>
            <button onclick="document.getElementById('video').volume-=0.1">volume-=0.1</button>
            <button onclick="document.getElementById('video').muted=true">muted=true</button>
            <button onclick="document.getElementById('video').muted=false">muted=false</button><br>
            <button onclick="document.getElementById('video').currentTime=document.getElementById('seek_pos').value">seek to </button>
             <input type="text" id='seek_pos' onkeydown="if(window.event.keyCode=='13'){document.getElementById('video').currentTime=document.getElementById('seek_pos').value;}">
            <button onclick="hls.level=parseInt(document.getElementById('manualLevel').value);">set level </button>
             <input type="text" id='manualLevel' onkeydown="if(window.event.keyCode=='13'){hls.level=parseInt(document.getElementById('manualLevel').value);}">
          </div>
          <video id=video controls autoplay oncanplaythrough="buffered_loaded(event);" onresize="buffered_resize(event);"">
          </video>
        </section>
      </article>
    </div>
    <!-- #main -->
    <pre id='HlsStatus'></pre>
    <pre id='HlsLevel'></pre>
    <canvas id="buffered_c" width="640" height="15" onclick="buffered_seek(event)";></canvas> <br>
    <button onclick="windowSliding=true;windowDuration=2000">window=2s</button>
    <button onclick="windowSliding=true;windowDuration=5000">=5s</button>
    <button onclick="windowSliding=true;windowDuration=10000">=10s</button>
    <button onclick="windowSliding=true;windowDuration=20000">=20s</button>
    <button onclick="windowSliding=true;windowDuration=30000">=30s</button>
    <button onclick="windowSliding=true;windowDuration=60000">=60s</button>
    <button onclick="windowSliding=true;windowDuration=120000">=120s</button>
    <button onclick="windowSliding=true;windowDuration=0">=infinity</button><br>
    <button onclick="var windowTime = getWindowTimeRange(); windowStart=windowTime.min;windowEnd=windowTime.max;document.getElementById('windowStart').value=windowStart;document.getElementById('windowEnd').value=windowEnd">use current sliding window for fixed window</button>
    <button onclick="windowSliding=!windowSliding">toggle sliding/fixed window</button>
    <button onclick="windowStart=document.getElementById('windowStart').value">fixed window start(ms)</button>
    <input type="text" id='windowStart' defaultValue="0" onkeydown="if(window.event.keyCode=='13'){windowStart=document.getElementById('windowStart').value;}">
    <button onclick="windowEnd=document.getElementById('windowEnd').value">fixed window end(ms)</button>
    <input type="text" id='windowEnd' defaultValue="10000" onkeydown="if(window.event.keyCode=='13'){windowEnd=document.getElementById('windowEnd').value;}">
    <canvas id="timerange_c" width="640" height="60" style="border:1px solid #000000" onmousedown="timeRangeCanvasonMouseDown(event)" onmousemove="timeRangeCanvasonMouseMove(event)" onmouseup="timeRangeCanvasonMouseUp(event)" onmouseout="timeRangeCanvasonMouseOut(event)";></canvas>
    <canvas id="buffertime_c" width="640" height="100" style="border:1px solid #000000";></canvas>
    <canvas id="event_c" width="640" height="15" style="border:1px solid #000000";></canvas><br>
  </div>
  <div id="buffered_log" style="font-size: small;"></div>


<br><br><br><br>Change Stream <br>
<input id="userInput" value="http://www.streambox.fr/playlists/test_001/stream.m3u8" size="80"> <button onclick="changeStream()">Load</button><br>

<h3> Test Videos </h3>
<ul id="streamlist"></ul>


  <script src="streams.js"></script>
  <script src="dm.js"></script>

  <script>
  function changeStream() {
    loadStream(video,document.getElementById('userInput').value);
  }
  function listStreams(list, container) {
    for(var i=0; i<list.length; i++) { var entry = document.createElement("li");
      entry.innerHTML = "<a href='#' onclick='return loadStream(video,\""+list[i].file+"\")'>"+((list[i].title !== undefined) ? list[i].title : list[i].file )+"</a>";
      document.getElementById(container).appendChild(entry);
    }
  }

  </script>
  <!-- live-reload script -->
  <script src="//localhost:8001"></script>
  <script src="../dist/hls.js"></script>
  <script src="canvas.js"></script>
  <script>

   'use strict';
   var hls;
   var _url;
   var video = document.getElementById('video');
   var events;
   video.volume = 0.05;
   var manifest = decodeURIComponent(location.search.split('src=')[1]);
   if(manifest === 'undefined') {
   manifest = 'http://www.streambox.fr/playlists/test_001/stream.m3u8';
   }

   loadStream(video,manifest);
   if(Hls.isSupported()) {
    listStreams(teststreams,"streamlist");
   }

  function loadStream(video,url) {
    hideCanvas();
     if(Hls.isSupported()) {
       if(hls) {
         hls.destroy();
         if(hls.bufferTimer) {
           clearInterval(hls.bufferTimer);
           hls.bufferTimer = undefined;
         }
       }
      var hlsLink = document.URL.split('?')[0] +  '?src=' + encodeURIComponent(url);
      var description = 'URL: ' + url + '<br>HLS link: ' + "<a href=\"" + hlsLink + "\">" + hlsLink + "</a>";
      if(url.indexOf('http') === -1) {
        var dmlink = 'http://www.dailymotion.com/video/' + url;
        description += '<br>DM link:' + "<a href=\"" + dmlink + "\">" + dmlink + "</a>";
      }
      document.getElementById("HlsUrl").innerHTML = description;
      document.getElementById("HlsStatus").innerHTML = 'loading ' + url;
       if(url.indexOf('http') === -1) {
        document.getElementById("HlsStatus").innerHTML = 'DM url detected, resolving ...';
        _url = getDMURL(url);
        if(_url) {
          document.getElementById("HlsStatus").innerHTML = 'DM url resolved';
        } else {
          document.getElementById("HlsStatus").innerHTML = 'unable to resolve DM url, aborting ...if not on DM domain, consider installing <a href=\"https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi\">Allow-Control-Allow-Origin</a> Chrome Extension';
          return;
        }
       } else {
        _url = url;
       }
       hls = new Hls(video);
       hls.debug(true);
       hls.on(hls.Events.FRAMEWORK_READY,function() {
          document.getElementById("HlsStatus").innerHTML = 'attaching URL to video tag';
          events = { load : [], buffer : []};
          document.getElementById('event_c').width = window.innerWidth-30;
          document.getElementById('buffertime_c').width = window.innerWidth-30;
          document.getElementById('timerange_c').width = window.innerWidth-30;
          hls.t0 = Date.now();
          hls.attachSource(_url);
       });
       hls.on(hls.Events.INIT_SEGMENT,function(event,data) {
          showCanvas();
          document.getElementById("HlsStatus").innerHTML = "playlist successfully loaded," + hls.levels.length + " levels found";
       });
       hls.on(hls.Events.LOAD_ERROR,function(event,data) {
          hls.destroy();
          document.getElementById("HlsStatus").innerHTML = "cannot Load <a href=\"" + data.url + "\">" + url + "</a><br>HTTP response code:" + data.response.status + "<br>" + data.response.statusText;
          if(data.response.status === 0) {
            document.getElementById("HlsStatus").innerHTML += "this is most probably a CORS issue, consider installing <a href=\"https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi\">Allow-Control-Allow-Origin</a> Chrome Extension";
          }
       });
       hls.on(hls.Events.LEVEL_SWITCH,function(event,data) {
          document.getElementById("HlsLevel").innerHTML = "manual level:" + hls.manualLevel + ",switching to level:" + data.id;
       });
       hls.on(hls.Events.LEVEL_LOADING,function(event,data) {
          document.getElementById("HlsLevel").innerHTML = "manual level:" + hls.manualLevel + ",loading level:" + data.id;
       });
       hls.on(hls.Events.MANIFEST_LOADED,function(event,data) {
          var event = {
            name : "variant manifest",
            time : data.stats.trequest - hls.t0,
            latency : data.stats.tfirst - data.stats.trequest,
            load : data.stats.tload - data.stats.tfirst,
            duration : data.stats.tload - data.stats.tfirst,
          };
          events.load.push(event);
          refreshCanvas();
       });
       hls.on(hls.Events.LEVEL_LOADED,function(event,data) {
          document.getElementById("HlsLevel").innerHTML = "manual level:" + hls.manualLevel + ",last loaded level:" + data.id;
          var event = {
            name : "stream manifest @ " + data.id,
            time : data.stats.trequest - hls.t0,
            latency : data.stats.tfirst - data.stats.trequest,
            load : data.stats.tload - data.stats.tfirst,
            duration : data.stats.tload - data.stats.tfirst
          };
          events.load.push(event);
          refreshCanvas();
       });
       hls.on(hls.Events.FRAGMENT_BUFFERED,function(event,data) {
          var event = {
            name : "fragment " + data.frag.sn + " @ " + data.frag.level,
            time : data.stats.trequest - hls.t0,
            latency : data.stats.tfirst - data.stats.trequest,
            load : data.stats.tload - data.stats.tfirst,
            demux : data.stats.tparsed - data.stats.tload,
            buffer : data.stats.tbuffered - data.stats.tparsed,
            duration : data.stats.tbuffered - data.stats.tfirst,
          };
          events.load.push(event);
          if(hls.bufferTimer === undefined) {
            var event2 = { time : new Date() - hls.t0, buffer : 0};
            events.buffer.push(event2);
            hls.bufferTimer = window.setInterval(updateBuffered, 100);
          }
          refreshCanvas();
       });
       hls.on(hls.Events.VIDEO_ERROR,function(event,data) {
          hls.destroy();
          document.getElementById("HlsStatus").innerHTML = "Video Error";
          document.getElementById('buffered_c').width = 0;
       });
    } else {
      if(navigator.userAgent.toLowerCase().indexOf('firefox') !== -1) {
      document.getElementById("HlsStatus").innerHTML = "you are using Firefox, it looks like MediaSource is not enabled,<br>please ensure the following keys are set appropriately in <b>about:config<br>media.mediasource.enabled=true<br>media.mediasource.ignore_codecs=true<br>media.mediasource.mp4.enabled=true<br>media.mediasource.youtubeonly=false</b>";
      } else {
        document.getElementById("HlsStatus").innerHTML = "your Browser does not support MediaSourceExtension / MP4 mediasource";
      }
    }
  }


function getRandomTestVid() {
  var idx = Math.floor(Math.random()*teststreams.length);
  return teststreams[idx].file;
}

function outputLog(msg) {
  document.getElementById('buffered_log').innerHTML = msg + "<br>";
}

function timeRangesToString(r) {
  var log = "";
  for (var i=0; i<r.length; i++) {
    log += "[" + r.start(i) + "," + r.end(i) + "]<br>";
  }
  return log;
}

  function updateBuffered() {
    var v = document.getElementById('video');
    var canvas = document.getElementById('buffered_c');
    var ctx = canvas.getContext('2d');
    var r = v.buffered;
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "gray";
    if (r) {
      if(!canvas.width || canvas.width !== v.videoWidth) {
        canvas.width = v.videoWidth;
      }
      var pos = v.currentTime,bufferLen;
      for (var i=0, bufferLen=0; i<r.length; i++) {
        var start = r.start(i)/v.duration * canvas.width;
        var end = r.end(i)/v.duration * canvas.width;
        ctx.fillRect(start, 3, Math.max(2, end-start), 10);
        if(pos >= r.start(i) && pos < r.end(i)) {
          // play position is inside this buffer TimeRange, retrieve end of buffer position and buffer length
          bufferLen = r.end(i) - pos;
        }
      }
      var event = { time : new Date() - hls.t0, buffer : bufferLen};
      events.buffer.push(event);
      refreshCanvas();
      var log = "position:<br>"
              + v.currentTime.toFixed(2)
              + "<br>"
              + "Buffered:<br>"
              + timeRangesToString(v.buffered)
              + "<br>"
              + "Seekable:<br>"
              + timeRangesToString(v.seekable)
              + "<br>";
      document.getElementById("buffered_log").innerHTML = log;
      ctx.fillStyle = "blue";
      var x = v.currentTime / v.duration * canvas.width;
      ctx.fillRect(x, 0, 2, 15);
    }
  }

  function showCanvas()  {
      document.getElementById('buffered_log').style.display="block";
      document.getElementById('buffered_c').style.display="block";
      document.getElementById('buffertime_c').style.display="block";
      document.getElementById('timerange_c').style.display="block";
      document.getElementById('event_c').style.display="block";
  }

  function hideCanvas()  {
      document.getElementById('buffered_log').style.display="none";
      document.getElementById('buffered_c').style.display="none";
      document.getElementById('buffertime_c').style.display="none";
      document.getElementById('timerange_c').style.display="none";
      document.getElementById('event_c').style.display="none";
  }



var timeRangeMouseDown=false;
 function timeRangeCanvasonMouseDown(evt) {
  var canvas = document.getElementById('timerange_c'),
      bRect = canvas.getBoundingClientRect(),
      mouseX = Math.round((evt.clientX - bRect.left)*(canvas.width/bRect.width));
      windowStart = Math.round(mouseX * getWindowTimeRange().now / canvas.width);
      windowEnd = windowStart+500;
      timeRangeMouseDown = true;
      windowSliding = false;
      //console.log('windowStart/windowEnd:' + '/' + windowStart + '/' + windowEnd);
      document.getElementById('windowStart').value=windowStart;
      document.getElementById('windowEnd').value=windowEnd;
 }

 function timeRangeCanvasonMouseMove(evt) {
    if(timeRangeMouseDown) {
      var canvas = document.getElementById('timerange_c'),
          bRect = canvas.getBoundingClientRect(),
          mouseX = Math.round((evt.clientX - bRect.left)*(canvas.width/bRect.width)),
          pos = Math.round(mouseX * getWindowTimeRange().now / canvas.width);

      console.log('pos/windowStart:' + '/' + pos + '/' + windowStart);
      if(pos < windowStart) {
        windowStart = pos;
      } else {
        windowEnd = pos;
      }
      if(windowStart === windowEnd) {
        // to avoid division by zero ...
        windowEnd +=50;
      }
      //console.log('windowStart/windowEnd:' + '/' + windowStart + '/' + windowEnd);
      document.getElementById('windowStart').value=windowStart;
      document.getElementById('windowEnd').value=windowEnd;
    }
 }

 function timeRangeCanvasonMouseUp(evt) {
  console.log(timeRangeCanvasonMouseUp);
  timeRangeMouseDown = false;
 }

 function timeRangeCanvasonMouseOut(evt) {
  console.log(timeRangeCanvasonMouseOut);
  timeRangeMouseDown = false;
 }

var windowDuration=20000,windowSliding=true,windowStart=0,windowEnd=10000;
document.getElementById('windowStart').value=windowStart;document.getElementById('windowEnd').value=windowEnd;
  function refreshCanvas()  {
      var windowTime = getWindowTimeRange();
      canvasLoadUpdate(document.getElementById('event_c'), windowTime.min,windowTime.max, events.load);
      canvasBufferUpdate(document.getElementById('buffertime_c'), windowTime.min,windowTime.max, events.buffer);
      canvasTimeRangeUpdate(document.getElementById('timerange_c'), 0, windowTime.now, windowTime.min,windowTime.max, events.buffer);
  }

  function getWindowTimeRange() {
      var tnow = new Date() - hls.t0,minTime,maxTime;
      if(windowSliding) {
        // let's show the last 60s from current time
        if(windowDuration) {
          minTime = Math.max(0, tnow-windowDuration),
          maxTime = Math.min(minTime + windowDuration, tnow);
        } else {
          minTime = 0;
          maxTime = tnow;
        }
      } else {
        minTime = windowStart;
        maxTime = windowEnd;
      }
      return { min : minTime, max: maxTime, now : tnow}
  }

  function minsecs(ts) {
    var m = Math.floor(Math.floor(ts % 3600) / 60);
    var s = Math.floor(ts % 60);
    return m + ":" + (s < 10 ? "0" : "") + s;
  }

  function buffered_seek(event) {
    var canvas = document.getElementById('buffered_c');
    var v = document.getElementById('video');
    var target = (event.clientX - canvas.offsetLeft) / canvas.width * v.duration;
    v.currentTime = target;
    outputLog("Seeking to " + target + " (" + minsecs(target) + ")");
  }

  function buffered_loaded(event) {
    var v = document.getElementById('video');
    if (!v.buffered) {
      outputLog('Buffered attribute not supported by your browser\n');
    } else {
      outputLog("Buffered attribute is supported, click on the black progress bar to seek.");
    }
  }

  function buffered_resize(event) {
    var canvas = document.getElementById('buffered_c');
    canvas.width = event.target.videoWidth;
    document.getElementById("HlsDimension").innerHTML = "video dimension:" + event.target.videoWidth + 'x' + event.target.videoHeight;
  }
  </script>
</body>

</html>
