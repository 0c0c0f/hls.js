<!DOCTYPE html>

<head>
  <title>HLS Media Sources Demo</title>
</head>

<body>
  <div class="header-container">
    <header class="wrapper clearfix">
      <h1 class="title">HLS Media Sources Demo</h1>
    </header>
  </div>

  <div class="main-container">
    <div class="main wrapper clearfix">
      <article>
        <header>
          <p>
            transmuxing HLS single level playlist into MP4 fragments - Media Source Extension-compatible media segments on the fly. Check out the demo below in Chrome!
          </p>
        </header>
        <section>
          <video id=video controls onloadedmetadata="buffered_loaded(event);">
          </video>
        </section>
      </article>
    </div>
    <!-- #main -->
    <pre id='HlsUrl'></pre>
    <pre id='HlsStatus'></pre>
    <canvas id="buffered_c" width="640" height="15" onclick="buffered_seek(event)";>
    </canvas> <br>
  </div>
  <div id="buffered_log" style="font-size: small;"></div>
<button style="font: bold 20px Arial" onclick="loadDMRandomVid()">Click to Load a random DM Video</button>

<br><br><br><br>Change Stream <br>
<input id="userInput" value="http://www.streambox.fr/playlists/test_001/stream.m3u8" size="80"> <button onclick="userSubmit()">Load</button><br>

<h3> Test Videos </h3>
<ul id="streamlist"></ul>


  <script src="streams.js"></script>

  <script>
  function userSubmit() {
    loadStream(video,document.getElementById('userInput').value);
  }
  function listStreams(list, container) {
    for(var i=0; i<list.length; i++) { var entry = document.createElement("li");
      entry.innerHTML = "<a href='#' onclick='return loadStream(video,\""+list[i].file+"\")'>"+list[i].title+"</a>";
      document.getElementById(container).appendChild(entry);
    }
  }

  </script>
  <!-- live-reload script -->
  <script src="//localhost:8001"></script>
  <script src="../dist/hls.js"></script>
  <script>

   'use strict';
   var hls;
   var video = document.getElementById('video');
   //var manifest = 'http://www.streambox.fr/playlists/test_001/stream_1000k_48k_640x360.m3u8';
   //var manifest = 'http://www.streambox.fr/playlists/test_001/stream.m3u8';
   //var manifest = 'http://media.sublimevideo.net/v/dm/hls/xwr14q.m3u8';
   //var manifest = 'http://sublimevideo-media.s3.amazonaws.com/v/dm/hls/xwr14q/55008890_mp4_h264_aac_hq.m3u8';
   //var manifest = 'http://media.sublimevideo.net/v/dm/hls/xwr14q.m3u8';
   //var manifest = 'http://www.flashls.org/playlists/issue_002/test.m3u8';
   var manifest = 'x2hijwc';
   loadStream(video,manifest);
   if(Hls.isSupported()) {
    listStreams(teststreams,"streamlist");
   }

  function loadStream(video,url) {
     if(Hls.isSupported()) {
       if(hls) {
        hls.destroy();
       }
      document.getElementById("HlsUrl").innerHTML = 'URL: ' + url;
      document.getElementById('buffered_c').style.display="none";
      document.getElementById('buffered_log').style.display="none";
      document.getElementById("HlsStatus").innerHTML = 'loading ' + url;
       if(url.indexOf('http') === -1) {
        document.getElementById("HlsStatus").innerHTML = 'DM url detected, resolving ...';
        url = getDMURL(url);
        if(url) {
          document.getElementById("HlsStatus").innerHTML = 'DM url resolved';
        } else {
          document.getElementById("HlsStatus").innerHTML = 'unable to resolve DM url, aborting ...if not on DM domain, consider installing <a href=\"https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi\">Allow-Control-Allow-Origin</a> Chrome Extension';
          return;
        }
       }
       hls = new Hls(video);
       hls.debug(true);
       hls.on(hls.Events.FRAMEWORK_READY,function() {
          document.getElementById("HlsStatus").innerHTML = 'attaching URL to video tag';
          hls.attachSource(url);
       });
       hls.on(hls.Events.INIT_SEGMENT,function() {
          document.getElementById('buffered_c').style.display="block";
          document.getElementById("HlsStatus").innerHTML = "playlist successfully loaded";
       });
       hls.on(hls.Events.LOAD_ERROR,function(event,data) {
          hls.destroy();
          document.getElementById("HlsStatus").innerHTML = "a Load Error happened, broken playlist or CORS issue ?";
          document.getElementById('buffered_c').style.display="none";
       });
       hls.on(hls.Events.VIDEO_ERROR,function(event,data) {
          hls.destroy();
          document.getElementById("HlsStatus").innerHTML = "a Video Error happened";
          document.getElementById('buffered_c').style.display="none";
       });
    } else {
      document.getElementById("HlsStatus").innerHTML = "your Browser does not support MediaSourceExtension / MP4 mediasource";
    }
  }

  function getDMURL(url) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'http://www.dailymotion.com/player/metadata/video/'+url , false);
    try {
      xhr.send(null);
    } catch(err) {
     return null;
    }

    if(xhr.status === 200) {
      return JSON.parse(xhr.responseText).qualities.auto[0].url;
    } else {
      return null;
    }
  }

function getDMRandomVid() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://api.dailymotion.com/videos?flags=no_live&limit=50' , false);
    try {
      xhr.send(null);
    } catch(err) {
     return null;
    }

    if(xhr.status === 200) {
      var obj = JSON.parse(xhr.responseText);
      var idx = Math.floor(Math.random()*obj.list.length);
      return JSON.parse(xhr.responseText).list[idx].id;
    } else {
      return null;
    }
}

function loadDMRandomVid() {
  var url = getDMRandomVid();
  if(url) {
    loadStream(video,url);
  } else {
    document.getElementById("HlsStatus").innerHTML = "unable to load DM random video lists, if not on DM domain, consider installing <a href=\"https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi\">Allow-Control-Allow-Origin Chrome Extension</a>";
  }

}

  function outputLog(msg) {
    document.getElementById('buffered_log').innerHTML = msg + "<br>";
  }

  function timeRangesToString(r) {
    var log = "";
    for (var i=0; i<r.length; i++) {
      log += "[" + r.start(i) + "," + r.end(i) + "]<br>";
    }
    return log;
  }

  function updateBuffered() {
    var v = document.getElementById('video');
    var canvas = document.getElementById('buffered_c');
    var ctx = canvas.getContext('2d');
    var r = v.buffered;
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "gray";
    if (r) {
      for (var i=0; i<r.length; i++) {
        var start = r.start(i)/v.duration * canvas.width;
        var end = r.end(i)/v.duration * canvas.width;
        ctx.fillRect(start, 3, Math.max(2, end-start), 10);
      }
      var log = "Buffered:<br>"
              + timeRangesToString(v.buffered)
              + "<br>"
              + "Seekable:<br>"
              + timeRangesToString(v.seekable)
              + "<br>";
      document.getElementById("buffered_log").innerHTML = log;
      ctx.fillStyle = "blue";
      var x = v.currentTime / v.duration * canvas.width;
      ctx.fillRect(x, 0, 2, 15);
    }
  }

  function minsecs(ts) {
    var m = Math.floor(Math.floor(ts % 3600) / 60);
    var s = Math.floor(ts % 60);
    return m + ":" + (s < 10 ? "0" : "") + s;
  }

  function buffered_seek(event) {
    var canvas = document.getElementById('buffered_c');
    var v = document.getElementById('video');
    var target = (event.clientX - canvas.offsetLeft) / canvas.width * v.duration;
    v.currentTime = target;
    outputLog("Seeking to " + target + " (" + minsecs(target) + ")");
  }

  function buffered_loaded(event) {
    var v = document.getElementById('video');
    if (!v.buffered) {
      outputLog('Buffered attribute not supported by your browser\n');
    } else {
      outputLog("Buffered attribute is supported, click on the black progress bar to seek.");
      window.setInterval(updateBuffered, 100);
    }
  }
  </script>
</body>

</html>
