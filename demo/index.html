<!DOCTYPE html>

<head>
  <title>hls.js demo page</title>
<link rel="icon" type="image/png" href="http://static1.dmcdn.net/images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="http://static1.dmcdn.net/images/favicon-16x16.png" sizes="16x16" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
</head>
<body>
  <div class="header-container">
    <header class="wrapper clearfix">
      <h1 class="title"><a href="https://github.com/dailymotion/hls.js">hls.js</a> demo page</h1>
    </header>
  </div>

  <div class="main-container">
    <div class="main wrapper clearfix">
      <article>
        <header>
          <p>
            transmuxing HLS playlist into MP4 fragments - Media Source Extension-compatible media segments on the fly.
            Check out the demo below in Chrome / Firefox or Safari !
          </p>
        </header>
        <section>
          <div id="customButtons"></div>
          <div id="customText"></div>
          <pre id='HlsUrl'></pre>
          <pre id='HlsStatus'></pre>
          <video id=video controls autoplay border="4" style="max-width:90%;margin-left:5%"></video>
          <canvas id="buffered_c" width="640" height="15" onclick="buffered_seek(event)" style="margin-left:5%";></canvas>
        <div>
        video dimension: <div id="currentResolution" style="display: inline;"></div>
        </div>
        <input type="range" min="0" step="1" value="0" id="videoWidthSlider" style="margin-left:5%;width:90%" oninput="videoWidthSliderChange()";/>
          <div id='buttons'>
            <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('video').play()">play</button>
            <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('video').pause()">pause</button>
            <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('video').currentTime+=10">currentTime+=10</button>
            <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('video').currentTime-=10">currentTime-=10</button>
            <button type="button" class="btn btn-sm btn-success" onclick="document.getElementById('video').currentTime=document.getElementById('seek_pos').value">seek to </button>
             <input type="text" id='seek_pos' size="8" onkeydown="if(window.event.keyCode=='13'){document.getElementById('video').currentTime=document.getElementById('seek_pos').value;}">
          </div>
        <div>
        current level: <div id="currentLevelControl" style="display: inline;"></div>
        </div>
        <div>
        next level: <div id="nextLevelControl" style="display: inline;"></div>
        </div>
        <div>
        load level: <div id="loadLevelControl" style="display: inline;"></div>
        </div>
        <div>
        cap level: <div id="levelCappingControl" style="display: inline;"></div>
        </div>
    <button type="button" class="btn btn-xs btn-success" onclick="hls.recoverNetworkError()">recover Network Error</button><br>
    <button type="button" class="btn btn-xs btn-success" onclick="hls.recoverMediaError()">recover Media Error</button><br>
    <div id="metricsButton">
        </section>
      </article>
    </div>
    <!-- #main -->
    <br>
    <h3 class="title">real time metrics</h1>
    <button type="button" class="btn btn-xs btn-success" onclick="toggleMetricsDisplay()">toggle metrics display</button><br>
    <div id="metricsButton">
    <button type="button" class="btn btn-xs btn-primary" onclick="windowSliding=!windowSliding; refreshCanvas()">toggle sliding/fixed window</button><br>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSetSliding(0)">window ALL</button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSetSliding(2000)">2s</button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSetSliding(5000)">5s</button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSetSliding(10000)">10s</button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSetSliding(20000)">20s</button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSetSliding(30000)">30s</button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSetSliding(60000)">60s</button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSetSliding(120000)">120s</button><br>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeZoomIn()">Window Zoom In</button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeZoomOut()">Window Zoom Out</button><br>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSlideLeft()"> <<< Window Slide </button>
    <button type="button" class="btn btn-xs btn-primary" onclick="timeRangeSlideRight()">Window Slide >>> </button><br>
    <button type="button" class="btn btn-xs btn-primary" onclick="windowStart=document.getElementById('windowStart').value">fixed window start(ms)</button>
    <input type="text" id='windowStart' defaultValue="0" size="8" onkeydown="if(window.event.keyCode=='13'){windowStart=document.getElementById('windowStart').value;}">
    <button type="button" class="btn btn-xs btn-primary" onclick="windowEnd=document.getElementById('windowEnd').value">fixed window end(ms)</button>
    <input type="text" id='windowEnd' defaultValue="10000" size="8" onkeydown="if(window.event.keyCode=='13'){windowEnd=document.getElementById('windowEnd').value;}"><br>
    <button type="button" class="btn btn-xs btn-success" onclick="exportmetrics()" style="font-size:18px">metrics permalink</button>
    <canvas id="bufferTimerange_c" width="640" height="100" style="border:1px solid #000000" onmousedown="timeRangeCanvasonMouseDown(event)" onmousemove="timeRangeCanvasonMouseMove(event)" onmouseup="timeRangeCanvasonMouseUp(event)" onmouseout="timeRangeCanvasonMouseOut(event)";></canvas>
    <canvas id="bitrateTimerange_c" width="640" height="100" style="border:1px solid #000000";></canvas>
    <canvas id="bufferWindow_c" width="640" height="100" style="border:1px solid #000000" onmousemove="windowCanvasonMouseMove(event)";></canvas>
    <canvas id="videoEvent_c" width="640" height="15" style="border:1px solid #000000";></canvas>
    <canvas id="loadEvent_c" width="640" height="15" style="border:1px solid #000000";></canvas><br>
  </div>
  </div>
  <pre id='HlsStats'></pre>
  <div id="buffered_log"></div>

<br>Change Stream <br>
<input id="userInput" value="http://www.streambox.fr/playlists/test_001/stream.m3u8" size="80"> <button type="button" class="btn btn-sm btn-primary" onclick="changeStream()">Load</button><br>

<h3> Test Videos </h3>
<ul id="streamlist"></ul>


  <script src="../../streams.js"></script>

  <script>
  function changeStream() {
    loadStream(document.getElementById('userInput').value);
  }

  </script>
  <!-- live-reload script -->
  <script src="//localhost:8001"></script>
  <script src="../dist/hls.js"></script>
  <script src="canvas.js"></script>
  <script src="metrics.js"></script>
  <script src="jsonpack.js"></script>
  <script>

   'use strict';
   var hls;
   var _url;
   var t0;
   var isLive = false;
   var video = document.getElementById('video');
   var events;
   video.volume = 0.05;
   var videoError = false;
   var manifest = decodeURIComponent(location.search.split('src=')[1]);
   if(manifest === 'undefined') {
     manifest = 'http://www.streambox.fr/playlists/test_001/stream.m3u8';
   }
   var videoWidthSlider=document.getElementById("videoWidthSlider");
   videoWidthSlider.max = 0.9*window.innerWidth;
   var capVideo=false;

  loadStream(manifest);


  function loadStream(url) {
    hideCanvas();
     if(Hls.isSupported()) {
       if(hls) {
         hls.destroy();
         if(hls.bufferTimer) {
            clearInterval(hls.bufferTimer);
           hls.bufferTimer = undefined;
         }
       }
      var hlsLink = document.URL.split('?')[0] +  '?src=' + encodeURIComponent(url);
      var description = 'URL: ' + url + '<br>HLS link: ' + "<a href=\"" + hlsLink + "\">" + hlsLink + "</a>";
      if(url.indexOf('http') === -1) {
        var dmlink = 'http://www.dailymotion.com/video/' + url;
        description += '<br>DM link:' + "<a href=\"" + dmlink + "\">" + dmlink + "</a>";
      }
      document.getElementById("HlsUrl").innerHTML = description;
      document.getElementById("HlsStatus").innerHTML = 'loading ' + url;
       if(url.indexOf('http') === -1) {
        document.getElementById("HlsStatus").innerHTML = 'DM url detected, resolving ...';
        _url = getDMURL(url);
        if(_url) {
          document.getElementById("HlsStatus").innerHTML = 'DM url resolved';
        } else {
          document.getElementById("HlsStatus").innerHTML = 'unable to resolve DM url, aborting ...if not on DM domain, consider installing <a href=\"https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi\">Allow-Control-Allow-Origin</a> Chrome Extension';
          return;
        }
       } else {
        _url = url;
       }
       t0 = Date.now();
       events = { url : _url, date : new Date(), load : [], buffer : [], video : [], level : [], bitrate : []};
       hls = new Hls({debug:true});
       document.getElementById("HlsStatus").innerHTML = 'loading manifest and attaching video element...';
       hls.loadSource(_url);
       hls.attachVideo(video);
       hls.on(Hls.Events.MSE_ATTACHED,function() {
          bufferingIdx = -1;
          events.video.push({time : new Date() - t0, type : "MSE attached"});
       });
       hls.on(Hls.Events.FRAG_PARSING_INIT_SEGMENT,function(event,data) {
          showCanvas();
          var event = {time : new Date() - t0, type : "init segment"};
          events.video.push(event);
       });
       hls.on(Hls.Events.LEVEL_SWITCH,function(event,data) {
          events.level.push({time : new Date() - t0, id : data.levelId, bitrate : Math.round(hls.levels[data.levelId].bitrate/1000)});
          updateLevelInfo();
       });
       hls.on(Hls.Events.MANIFEST_LOADED,function(event,data) {
          var event = {
            type : "manifest",
            name : "",
            start : 0,
            end : data.levels.length,
            time : data.stats.trequest - t0,
            latency : data.stats.tfirst - data.stats.trequest,
            load : data.stats.tload - data.stats.tfirst,
            duration : data.stats.tload - data.stats.tfirst,
          };
          events.load.push(event);
          refreshCanvas();
       });
       hls.on(Hls.Events.MANIFEST_PARSED,function(event,data) {
         document.getElementById("HlsStatus").innerHTML = "manifest successfully loaded," + hls.levels.length + " levels found";
         updateLevelInfo();
       });
       hls.on(Hls.Events.LEVEL_LOADED,function(event,data) {
          //document.getElementById("HlsLevel").innerHTML = "manual level:" + hls.manualLevel + ",last loaded level:" + data.levelId;
          isLive = data.details.live;
          var event = {
            type : "level",
            id : data.levelId,
            start : data.details.startSN,
            end : data.details.endSN,
            time : data.stats.trequest - t0,
            latency : data.stats.tfirst - data.stats.trequest,
            load : data.stats.tload - data.stats.tfirst,
            duration : data.stats.tload - data.stats.tfirst
          };
          events.load.push(event);
          refreshCanvas();
       });
       hls.on(Hls.Events.FRAG_BUFFERED,function(event,data) {
          var event = {
            type : "fragment",
            id : data.frag.level,
            id2 : data.frag.sn,
            time : data.stats.trequest - t0,
            latency : data.stats.tfirst - data.stats.trequest,
            load : data.stats.tload - data.stats.tfirst,
            demux : data.stats.tparsed - data.stats.tload,
            buffer : data.stats.tbuffered - data.stats.tparsed,
            duration : data.stats.tbuffered - data.stats.tfirst,
            bw : Math.round(8*data.stats.length/(data.stats.tbuffered - data.stats.tfirst)),
            size : data.stats.length
          };
          events.load.push(event);
          events.bitrate.push({time : new Date() - t0, bitrate : event.bw , duration : data.frag.duration, level : event.id});
          if(hls.bufferTimer === undefined) {
            events.buffer.push({ time : 0, buffer : 0, pos: 0});
            hls.bufferTimer = window.setInterval(checkBuffer, 100);
          }
          refreshCanvas();
          updateLevelInfo();
       });
       hls.on(Hls.Events.FRAG_CHANGED,function(event,data) {
        var event = {time : new Date() - t0, type : 'frag changed', name : data.frag.sn + ' @ ' + data.frag.level };
        events.video.push(event);
        refreshCanvas();
        updateLevelInfo();
       });

       hls.on(Hls.Events.ERROR, function(event,data) {
        switch(data.details) {
          case Hls.ErrorDetails.MANIFEST_LOAD_ERROR:
            try {
              document.getElementById("HlsStatus").innerHTML = "cannot Load <a href=\"" + data.url + "\">" + url + "</a><br>HTTP response code:" + data.response.status + "<br>" + data.response.statusText;
                if(data.response.status === 0) {
                  document.getElementById("HlsStatus").innerHTML += "this is most probably a CORS issue, consider installing <a href=\"https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi\">Allow-Control-Allow-Origin</a> Chrome Extension";
                }
            } catch(err) {
              document.getElementById("HlsStatus").innerHTML = "cannot Load <a href=\"" + data.url + "\">" + url + "</a><br>Reason:Load " + data.event.type;
            }
            break;
          case Hls.ErrorDetails.LEVEL_LOAD_ERROR:
            document.getElementById("HlsStatus").innerHTML = "error while trying to load level playlist";
            break;
          case Hls.ErrorDetails.LEVEL_SWITCH_ERROR:
            document.getElementById("HlsStatus").innerHTML = "error while trying to switch to level " + data.level;
            break;
          case Hls.ErrorDetails.FRAG_LOAD_ERROR:
            document.getElementById("HlsStatus").innerHTML = "error while trying to load fragment " + data.frag.url;
            break;
          case Hls.ErrorDetails.LEVEL_LOAD_TIMEOUT:
            document.getElementById("HlsStatus").innerHTML = "timeout while trying to load level playlist";
            break;
          case Hls.ErrorDetails.FRAG_PARSING_ERROR:
            hls.destroy();
            document.getElementById("HlsStatus").innerHTML = "Parsing Error:" + data;
            document.getElementById('buffered_c').width = 0;
            videoError = true;
            break;
          case Hls.ErrorDetails.FRAG_APPENDING_ERROR:
            document.getElementById("HlsStatus").innerHTML = "Frag Appending Error";
            break;
          default:
            break;
        }
        if(data.fatal) {
          switch(data.type) {
            case Hls.ErrorTypes.MEDIA_ERROR:
              document.getElementById("HlsStatus").innerHTML += ",try to recover media Error ...";
              hls.recoverMediaError();
              videoError = true;
              break;
            case Hls.ErrorTypes.NETWORK_ERROR:
            document.getElementById("HlsStatus").innerHTML += ",network error press on button to recover ...";
              break;
            default:
              document.getElementById("HlsStatus").innerHTML += ", unrecoverable error, destroying context ...";
              hls.destroy();
              break;
          }
        }
       });

       hls.on(Hls.Events.FPS_DROP,function(event,data) {
          var evt = {time : new Date() - t0, type : "frame drop", name : data.currentDropped + "/" + data.currentDecoded};
          events.video.push(evt);
       });
       video.addEventListener('resize', handleVideoEvent);
       video.addEventListener('seeking', handleVideoEvent);
       video.addEventListener('seeked', handleVideoEvent);
       video.addEventListener('pause', handleVideoEvent);
       video.addEventListener('play', handleVideoEvent);
       video.addEventListener('playing', handleVideoEvent);
       video.addEventListener('error', handleVideoEvent);
       video.addEventListener('loadedmetadata', handleVideoEvent);
       video.addEventListener('loadeddata', handleVideoEvent);
       video.addEventListener('durationchange', handleVideoEvent);
    } else {
      if(navigator.userAgent.toLowerCase().indexOf('firefox') !== -1) {
      document.getElementById("HlsStatus").innerHTML = "you are using Firefox, it looks like MediaSource is not enabled,<br>please ensure the following keys are set appropriately in <b>about:config</b><br>media.mediasource.enabled=true<br>media.mediasource.mp4.enabled=true<br><b>media.mediasource.whitelist=false</b>";
      } else {
        document.getElementById("HlsStatus").innerHTML = "your Browser does not support MediaSourceExtension / MP4 mediasource";
      }
    }
  }


var lastSeekingIdx, lastStartPosition,lastDuration;
  function handleVideoEvent(evt) {
    var data = '';
    switch(evt.type) {
       case 'durationchange':
       if(evt.target.duration - lastDuration <= 0.5) {
        // some browsers reports several duration change events with almost the same value ... avoid spamming video events
        return;
       }
        lastDuration = evt.target.duration;
         data = Math.round(evt.target.duration*1000);
         break;
      case 'resize':
        data = evt.target.videoWidth + '/' + evt.target.videoHeight;
        if(capVideo==false) {
            document.getElementById("videoWidthSlider").value = evt.target.clientWidth;
        }
        break;
      case 'loadedmetadata':
      //   data = 'duration:' + evt.target.duration + '/videoWidth:' + evt.target.videoWidth + '/videoHeight:' + evt.target.videoHeight;
      //  break;
      case 'loadeddata':
      // case 'canplay':
      // case 'canplaythrough':
      case 'seeking':
      case 'seeked':
      case 'play':
      case 'playing':
        lastStartPosition = evt.target.currentTime;
      case 'pause':
      case 'waiting':
      case 'stalled':
      case 'error':
        data = Math.round(evt.target.currentTime*1000);
        if(evt.type === 'error') {
          var errorTxt,mediaError=evt.currentTarget.error;
          switch(mediaError.code) {
            case mediaError.MEDIA_ERR_ABORTED:
               errorTxt = "You aborted the video playback";
              break;
            case mediaError.MEDIA_ERR_DECODE:
              errorTxt = "The video playback was aborted due to a corruption problem or because the video used features your browser did not support,try to recover video Error";
              hls.recoverMediaError();
              break;
            case mediaError.MEDIA_ERR_NETWORK:
              errorTxt = "A network error caused the video download to fail part-way";
              break;
            case mediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
              errorTxt = "The video could not be loaded, either because the server or network failed or because the format is not supported";
              break;
          }
          document.getElementById("HlsStatus").innerHTML = errorTxt;
          videoError = true;
        }
        break;
      // case 'progress':
      //   data = 'currentTime:' + evt.target.currentTime + ',bufferRange:[' + this.video.buffered.start(0) + ',' + this.video.buffered.end(0) + ']';
      //   break;
      default:
      break;
    }
    var event = {time : new Date() - t0, type : evt.type, name : data};
    events.video.push(event);
    if(evt.type === 'seeking') {
      lastSeekingIdx = events.video.length-1;
    }
    if(evt.type === 'seeked') {
      events.video[lastSeekingIdx].duration = event.time - events.video[lastSeekingIdx].time;
    }
  }

function timeRangesToString(r) {
  var log = "";
  for (var i=0; i<r.length; i++) {
    log += "[" + r.start(i) + "," + r.end(i) + "]";
  }
  return log;
}

  var bufferingIdx = -1;
  var playbackEnded = false;

  function checkBuffer() {
    var v = document.getElementById('video');
    var canvas = document.getElementById('buffered_c');
    var ctx = canvas.getContext('2d');
    var r = v.buffered;
    var bufferingDuration;
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "gray";
    if (r) {
      if(!canvas.width || canvas.width !== v.clientWidth) {
        canvas.width = v.clientWidth;
      }
      var pos = v.currentTime,bufferLen;
      for (var i=0, bufferLen=0; i<r.length; i++) {
        var start = r.start(i)/v.duration * canvas.width;
        var end = r.end(i)/v.duration * canvas.width;
        ctx.fillRect(start, 3, Math.max(2, end-start), 10);
        if(pos >= r.start(i) && pos < r.end(i)) {
          // play position is inside this buffer TimeRange, retrieve end of buffer position and buffer length
          bufferLen = r.end(i) - pos;
        }
      }
      // check if we are in buffering / or playback ended state
      if(bufferLen <= 0.1 && v.paused === false && (pos-lastStartPosition) > 0.5) {
        // don't create buffering event if we are at the end of the playlist, don't report ended for live playlist
        if(lastDuration -pos <= 0.5  && isLive === false) {
          if(playbackEnded === false) {
            events.video.push({ type : 'ended' , time : new Date() - t0 });
            playbackEnded = true;
          }
        } else {
         // we are not at the end of the playlist ... real buffering
          if(bufferingIdx !== -1) {
            bufferingDuration = new Date() - t0 - events.video[bufferingIdx].time;
            events.video[bufferingIdx].duration = bufferingDuration;
            events.video[bufferingIdx].name = bufferingDuration;
          } else {
            events.video.push({ type : 'buffering' , time : new Date() - t0 });
            // we are in buffering state
            bufferingIdx = events.video.length-1;
          }
          playbackEnded = false;
        }
      } else {
        playbackEnded = false;
      }

      if(bufferLen > 0.1 && bufferingIdx !=-1) {
          bufferingDuration = new Date() - t0 - events.video[bufferingIdx].time;
          events.video[bufferingIdx].duration = bufferingDuration;
          events.video[bufferingIdx].name = bufferingDuration;
        // we are out of buffering state
        bufferingIdx = -1;
      }

      // update buffer/position for current Time
      var event = { time : new Date() - t0, buffer : Math.round(bufferLen*1000), pos: Math.round(pos*1000)};
      var bufEvents = events.buffer, bufEventLen = bufEvents.length;
      if(bufEventLen > 1) {
        var event0 = bufEvents[bufEventLen-2],event1 = bufEvents[bufEventLen-1];
        var slopeBuf0 = (event0.buffer - event1.buffer)/(event0.time-event1.time);
        var slopeBuf1 = (event1.buffer - event.buffer)/(event1.time-event.time);

        var slopePos0 = (event0.pos - event1.pos)/(event0.time-event1.time);
        var slopePos1 = (event1.pos - event.pos)/(event1.time-event.time);
        // compute slopes. if less than 30% difference, remove event1
        if((slopeBuf0 === slopeBuf1 || Math.abs(slopeBuf0/slopeBuf1 -1) <= 0.3) &&
           (slopePos0 === slopePos1 || Math.abs(slopePos0/slopePos1 -1) <= 0.3))
         {
          bufEvents.pop();
        }
      }
      events.buffer.push(event);
      refreshCanvas();

      var decodedFrames, droppedFrames;
      if(navigator.userAgent.toLowerCase().indexOf('firefox') !== -1) {
        decodedFrames = v.mozDecodedFrames;
        droppedFrames = v.mozParsedFrames-v.mozPresentedFrames;
      } else {
        decodedFrames = v.webkitDecodedFrameCount;
        droppedFrames = v.webkitDroppedFrameCount;
      }
      var log = "Buffered:"
              + timeRangesToString(v.buffered) + "<br>"
              + "Seekable:"
              + timeRangesToString(v.seekable) + "<br>"
              + "Played:"
              + timeRangesToString(v.played) + "<br>"
              + "Decoded Frames:"
              + decodedFrames + "<br>"
              + "Dropped Frames:"
              + droppedFrames + "<br>";
      document.getElementById("buffered_log").innerHTML = log;
      document.getElementById("HlsStats").innerHTML = JSON.stringify(hls.stats,null,"\t");
      ctx.fillStyle = "blue";
      var x = v.currentTime / v.duration * canvas.width;
      ctx.fillRect(x, 0, 2, 15);
    }

  }

  function showCanvas()  {
      showMetrics();
      document.getElementById('buffered_log').style.display="block";
      document.getElementById('buffered_c').style.display="block";
  }

  function hideCanvas()  {
      hideMetrics();
      document.getElementById('buffered_log').style.display="none";
      document.getElementById('buffered_c').style.display="none";
  }


  function exportmetrics() {
    var url = document.URL;
    var json = JSON.stringify(events);
    var jsonpacked = jsonpack.pack(json);
    //console.log(jsonpacked);
    var b64 = btoa(jsonpacked);
    console.log("packing JSON from " + json.length + " to " + jsonpacked.length + " bytes");
    url = url.substr(0,url.lastIndexOf("/")+1) + 'metrics.html?data=' + b64;
    console.log(url);
    window.open(url,'_blank');
  }

  function minsecs(ts) {
    var m = Math.floor(Math.floor(ts % 3600) / 60);
    var s = Math.floor(ts % 60);
    return m + ":" + (s < 10 ? "0" : "") + s;
  }

  function buffered_seek(event) {
    var canvas = document.getElementById('buffered_c');
    var v = document.getElementById('video');
    var target = (event.clientX - canvas.offsetLeft) / canvas.width * v.duration;
    v.currentTime = target;
  }

  function updateLevelInfo() {
    var button_template = '<button type="button" class="btn btn-sm ';
    var button_enabled  = 'btn-primary" ';
    var button_disabled = 'btn-success" ';

    var html1 = button_template;
    if(hls.autoLevelEnabled) {
      html1 += button_enabled;
    } else {
      html1 += button_disabled;
    }
    html1 += 'onclick="hls.currentLevel=-1">auto</button>';


    var html2 = button_template;
    if(hls.autoLevelEnabled) {
      html2 += button_enabled;
    } else {
      html2 += button_disabled;
    }
    html2 += 'onclick="hls.loadLevel=-1">auto</button>';

    var html3 = button_template;
    if(hls.autoLevelCapping === -1) {
      html3 += button_enabled;
    } else {
      html3 += button_disabled;
    }
    html3 += 'onclick="hls.autoLevelCapping=-1;updateLevelInfo()">none</button>';

    var html4 = button_template;
    if(hls.autoLevelEnabled) {
      html4 += button_enabled;
    } else {
      html4 += button_disabled;
    }
    html4 += 'onclick="hls.nextLevel=-1">auto</button>';

    for (var i=0; i < hls.levels.length; i++) {
      html1 += button_template;
      if(hls.currentLevel === i) {
        html1 += button_enabled;
      } else {
        html1 += button_disabled;
      }
      html1 += 'onclick="hls.currentLevel=' + i + '">' + i + '</button>';


      html2 += button_template;
      if(hls.loadLevel === i) {
        html2 += button_enabled;
      } else {
        html2 += button_disabled;
      }
      html2 += 'onclick="hls.loadLevel=' + i + '">' + i + '</button>';

      html3 += button_template;
      if(hls.autoLevelCapping === i) {
        html3 += button_enabled;
      } else {
        html3 += button_disabled;
      }
      html3 += 'onclick="hls.autoLevelCapping=' + i + ';updateLevelInfo()">' + i + '</button>';

      html4 += button_template;
      if(hls.nextLevel === i) {
        html4 += button_enabled;
      } else {
        html4 += button_disabled;
      }
      html4 += 'onclick="hls.nextLevel=' + i + '">' + i + '</button>';
    }
    var v = document.getElementById('video');
    if(v.videoWidth) {
      document.getElementById('currentResolution').innerHTML = v.videoWidth + 'x' + v.videoHeight;
    }
    document.getElementById('currentLevelControl').innerHTML = html1;
    document.getElementById('loadLevelControl').innerHTML = html2;
    document.getElementById('levelCappingControl').innerHTML = html3;
    document.getElementById('nextLevelControl').innerHTML = html4;
  }

  function videoWidthSliderChange() {
    document.getElementById('video').width = document.getElementById("videoWidthSlider").valueAsNumber;
    capVideo=true;
  }

  </script>
</body>

</html>
