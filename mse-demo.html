<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>HLS Media Sources Demo</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width">

</head>

<body>
  <div class="header-container">
    <header class="wrapper clearfix">
      <h1 class="title">HLS Media Sources Demo</h1>
    </header>
  </div>

  <div class="main-container">
    <div class="main wrapper clearfix">

      <article>
        <header>
          <p>
            transmuxing HLS single level playlist into MP4 fragments - Media Source Extension-compatible media segments on the fly. Check out the demo below in Chrome!
          </p>
        </header>
        <section>
          <video id=video width=640 height=360 controls>
            <p>
              Your browser is too old to view this demo. How about upgrading?
            </p>
          </video>
        </section>
      </article>

    </div>
    <!-- #main -->
  </div>
  <!-- #main-container -->

  <div class="footer-container">
    <footer class="wrapper">
    </footer>
  </div>
  <script src="src/hls.js"></script>
  <script src="src/utils/stream.js"></script>
  <script src="src/loader/playlist-loader.js"></script>
  <script src="src/loader/fragment-loader.js"></script>
  <script src="src/remux/mp4-generator.js"></script>
  <script src="src/demux/exp-golomb.js"></script>
  <script src="src/demux/tsdemuxer.js"></script>
  <!--<script src="test/mp4-inspector.js"></script> -->
  <script>
    var mediaSource = new MediaSource(),
      video = document.getElementById('video');

    // setup the media source
    mediaSource.addEventListener('sourceended', function() {
      console.log("media source ended");
    });

    mediaSource.addEventListener('sourceclose', function() {
      console.log("media source closed");
    });
    mediaSource.addEventListener('sourceopen', function() {
      var buffer = mediaSource.addSourceBuffer('video/mp4;codecs=avc1.4d400d,mp4a.40.5'),
        transmuxer = new hls.demux.TSDemuxer(),
        segments = [];

      buffer.addEventListener('updateend', function() {
        appendSegments();
      });

      buffer.addEventListener('error', function(event) {
        console.log(" buffer append error:" + event);
      });

      var fragments;
      var fragmentIndex;

      var playlistLoader = new hls.playlistLoader();
      var fragmentLoader = new hls.fragmentLoader();

      playlistLoader.on('data',function(data) {
        fragments = data;
          fragmentIndex = 0;
          fragmentLoader.load(fragments[fragmentIndex++]);
      });

      playlistLoader.on('stats', function(stats) {
        var rtt,loadtime,bw;
        rtt = stats.tfirst - stats.trequest;
        loadtime = stats.tend - stats.trequest;
        console.log("playlist loaded,RTT(ms)/load(ms)/nb frag:" + rtt + "/" + loadtime + "/" + stats.length);
      });


      fragmentLoader.on('data', function(data) {
        transmuxer.push(new Uint8Array(data));
        transmuxer.end();
        appendSegments();
        if (fragmentIndex < fragments.length) {
          fragmentLoader.load(fragments[fragmentIndex++]);
        } else {
          console.log("last fragment loaded");
          appendSegments();
        }
      });

      fragmentLoader.on('stats', function(stats) {
        var rtt,loadtime,bw;
        rtt = stats.tfirst - stats.trequest;
        loadtime = stats.tend - stats.trequest;
        bw = stats.length*8/(1000*loadtime);
        console.log("frag loaded, RTT(ms)/load(ms)/bitrate:" + rtt + "/" + loadtime + "/" + bw.toFixed(3) + " Mb/s");
      });

      // transmux the MPEG-TS data to ISO-BMFF segments
      transmuxer.on('data', function(segment) {
        //console.log(JSON.stringify(hls.inspectMp4(segment.data)),null,4);
        segments.push(segment);
      });

      function appendSegments() {
        if (!buffer.updating && segments.length) {
          //console.log("append " + segments[0].data.length);
          buffer.appendBuffer(segments.shift().data);
        }
      }

    var manifest = 'http://www.streambox.fr/playlists/test_001/stream_1000k_48k_640x360.m3u8';
    playlistLoader.load(manifest);
    });


    function logEvt(evt) {
      var data = '';
      switch(evt.type) {
        case 'durationchange':
          data = event.target.duration;
          break;
        case 'resize':
          data = "videoWidth:" + evt.target.videoWidth + "/videoHeight:" + evt.target.videoHeight;
          break;
        case 'loadedmetadata':
          data = "duration:" + evt.target.duration + "/videoWidth:" + evt.target.videoWidth + "/videoHeight:" + evt.target.videoHeight;
          break;
        case 'loadeddata':
        case 'canplay':
        case 'canplaythrough':
        case 'timeupdate':
        case 'seeking':
        case 'seeked':
        case 'pause':
        case 'play':
        case 'stalled':
          data = "currentTime:" + evt.target.currentTime;
          break;
        default:
        break;
      }
      console.log(evt.type + ":" + data);
    }

    video.src = URL.createObjectURL(mediaSource);
    video.addEventListener('loadstart', function(evt) { logEvt(evt); }) ;
    video.addEventListener('progress', function(evt) { logEvt(evt); }) ;
    video.addEventListener('suspend', function(evt) { logEvt(evt); }) ;
    video.addEventListener('abort', function(evt) { logEvt(evt); }) ;
    video.addEventListener('error', function(evt) { logEvt(evt); }) ;
    video.addEventListener('emptied', function(evt) { logEvt(evt); }) ;
    video.addEventListener('stalled', function(evt) { logEvt(evt); }) ;
    video.addEventListener('loadedmetadata', function(evt) { logEvt(evt); }) ;
    video.addEventListener('loadeddata', function(evt) { logEvt(evt); }) ;
    video.addEventListener('canplay', function(evt) { logEvt(evt); }) ;
    video.addEventListener('canplaythrough', function(evt) { logEvt(evt); }) ;
    video.addEventListener('playing', function(evt) { logEvt(evt); }) ;
    video.addEventListener('waiting', function(evt) { logEvt(evt); }) ;
    video.addEventListener('seeking', function(evt) { logEvt(evt); }) ;
    video.addEventListener('seeked', function(evt) { logEvt(evt); }) ;
    video.addEventListener('durationchange', function(evt) { logEvt(evt); }) ;
    video.addEventListener('timeupdate', function(evt) { logEvt(evt); }) ;
    video.addEventListener('play', function(evt) { logEvt(evt); }) ;
    video.addEventListener('pause', function(evt) { logEvt(evt); }) ;
    video.addEventListener('ratechange', function(evt) { logEvt(evt); }) ;
    video.addEventListener('resize', function(evt) { logEvt(evt); }) ;
    video.addEventListener('volumechange', function(evt) { logEvt(evt); }) ;

  </script>
</body>

</html>
